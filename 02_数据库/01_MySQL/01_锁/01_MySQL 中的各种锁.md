# 01_MySQL 中的各种锁

[toc]

## 简介

MySQL 中的锁机制是用来控制多个事务对共享资源（如表或行）访问的一种机制，保证数据库的一致性和事务的隔离性。MySQL 支持多种锁机制，主要由 InnoDB 存储引擎实现。

在MySQL中，主要有两种类型的锁：共享锁（读锁）和排他锁（写锁）。

---

## 共享锁&排他锁

### 共享锁（Shared Lock)

共享锁，也被称为读锁，读取操作创建的锁，是一种允许多个读取事务同时访问同一数据项的锁。

共享锁是一种允许多个事务同时读取某一资源（如一行或一张表）的锁，但不允许任何事务修改该资源，直到已释放所有共享锁。

### 排他锁（Exclusive Lock）

排他锁，也称为写锁，是一种阻止其他事务对数据进行读取或写入的锁。当一个事务对数据加上排他锁后，该事务可以自由地读取和修改这些数据，但其他事务无法同时读取或修改，直到排他锁被释放。这保证了写操作的完整性和独立性。



[共享锁和排他锁详细介绍]: ./02_共享锁和排他锁.md	"共享锁和排他锁"

---

## 意向锁（Intention Locks）

意向锁（Intention Locks）是InnoDB存储引擎中用来支持多粒度锁定（table locks and row locks同时存在）的一种锁机制，它主要用于支持行级锁。

**意向锁是表级锁**，当一个事务请求获取一个行级锁或表级锁时，MySQL会自动获取相应的表的意向锁。

意向锁分为两种类型：

1. **意向共享锁（Intention Shared Lock, IS）**：表示事务打算在资源上设置共享锁（读锁）。这通常用于表示事务计划读取资源，并不希望在读取时有其他事务设置排它锁。
2. **意向排他锁（Intention Exclusive Lock, IX）**：表示事务打算在资源上设置排它锁（写锁）。这表示事务计划修改资源，并不希望有其他事务同时设置共享或排它锁。



[意向锁]: ./03_意向锁	"意向锁"

---

## 记录锁（Record Lock）

记录锁（Record Lock）是行级锁的一种，用于锁定数据库表中的特定行。

记录锁锁定不是这行记录，而是这行记录对应的主键索引。

如果该表没有定义索引，InnoDB 会隐式创建一个聚簇索引（也称为主键索引），并基于该索引加锁。

如果 SQL 中不是操作的主键索引，那么会通过其他索引来查找到记录，然后锁定记录的主键索引。

记录锁包括共享锁（S锁）和排他锁（X锁）：

- **共享锁（S锁）**：允许多个事务同时读取相同的记录，但不允许修改。
- **排他锁（X锁）**：只允许一个事务读取或修改记录，其他事务不能同时读取或修改。



[记录锁]: 04_记录锁	"记录锁"

---

## 间隙锁

在 MySQL 中，间隙锁（Gap Lock）是 InnoDB 存储引擎的一种特殊类型的行级锁，用于防止幻读现象，确保事务的隔离级别达到可重复读（REPEATABLE READ）。

间隙锁主要在范围查询和唯一性检查时使用，它通过锁定索引记录之间的间隙，而不是锁定实际的索引记录或行。

它主要用于聚簇索引和辅助索引，防止其他事务在这些间隙中插入新记录，或者防止多个事务同时插入相同的值，从而避免幻读现象。

间隙锁只在操作范围内的记录时会出现，如果是基于唯一索引或主键索引的唯一记录操作，即只操作一条记录，不会加间隙锁。

间隙锁只锁定范围，不锁定具体的行记录，即锁定的区间是开区间（a,b）。



[间隙锁]: ./05_间隙锁	"间隙锁"

---

## 临键锁

在 MySQL 的 InnoDB 存储引擎中，临键锁实际上是两种锁的结合：记录锁和间隙锁。记录锁是在数据行的索引记录上直接加锁，而间隙锁则锁定索引记录之间的间隙。因此，临键锁锁定的是一个索引记录以及该记录之前的间隙。

临键锁通过锁定索引记录以及紧邻索引记录之间的间隙（gap），这样即使是范围查询，也能够确保事务的一致性，防止其他事务对这些范围内的数据进行插入、更新或删除操作。

临键锁用于解决幻读现象，确保事务的隔离级别达到可重复读（REPEATABLE READ）。

临键锁锁定的也是范围，锁定的范围是左开又闭的(a,b]。



[临键锁]: ./06_临键锁	"临键锁"

---

## 间隙锁和临键锁的锁定范围

间隙锁只锁定开区间范围的，临键锁在间隙锁的锁定范围的基础上，结合记录锁，锁定一个左开右闭的区间范围。



[间隙锁和临键锁的锁定范围]: ./06-1_间隙锁和临键锁的锁定范围	"间隙锁和临键锁的锁定范围"

---

## 行级锁的加锁流程

MySQL 的 InnoDB 引擎下的 RR（Repeatable Read） 级别中，加锁的基本单位是临键锁（Next-Key Lock），只要扫描到的数据都会被加锁，唯一索引上的范围查询会访问到不满足条件的第一个为止。

通过记录锁、间隙锁和临键锁的配合，InnoDB 能够有效地管理并发事务，防止数据不一致和幻读现象。这些锁的加锁流程确保了在不同的查询和修改操作中，事务之间能够协调进行，提供了高效的并发控制和数据保护机制。在设计高并发系统时，理解和正确使用这些锁有助于提升系统的性能和可靠性。



[行级锁的加锁流程]: ./09_行级锁的加锁流程	"行级锁的加锁流程"

---

## 有了行级锁，为什么还会幻读？

通过了解间隙锁、临键锁以及临键锁，我们知道行级锁的加锁基本单位是临键锁，而临键锁又是间隙锁和临键锁的组合，这三种锁都可以用来避免幻读的问题，但是 MySQL 在 Repeatable Read（可重复读）这个事务隔离级别下，还是会出现幻读现象，为什么？



[有了行级锁，为什么还会幻读？]: ./10_有了行级锁，RR级别下为什么还会幻读.md	"有了行级锁，为什么还会幻读？"

---

## 插入意向锁

插入意向锁是一种特殊的间隙锁，主要用于管理间隙锁（Gap Lock）和行锁（Record Lock）之间的兼容性。它是一种优化机制，使得多个事务能够同时插入同一个间隙（Gap）中的不同位置，而不会彼此阻塞。

假设有索引记录的值为 4 和7。分别尝试插入值为5和6的不同事务，在获取插入行的独占锁之前，各自用插入意向锁锁定 4 和7 之间的间隙，但由于行不冲突，所以它们不会相互阻塞。但是如果他们的都要插入6，那么就会需要阻塞了。



[插入意向锁]: ./07_插入意向锁	"插入意向锁"

---

## AUTO-INC 锁

`AUTO-INC 锁`（Auto-Increment Lock）是 MySQL InnoDB 存储引擎中的一种特殊锁机制，用于处理自增列（AUTO_INCREMENT）在并发环境下的安全性和性能问题。**该锁确保多个事务在并发插入自增列时能够生成唯一且连续的自增值。**

在 MySQL 5.1之前，`AUTO-INC` 锁是一个表级锁，它在第一个插入操作开始时被获取，并持续到整个事务结束。这意味着同一时刻只有一个事务能对该表进行插入操作，这虽然保证了自增值的唯一性和连续性，但限制了并发性能。
从MysQL 5.1开始，InnoDB引入了一种新的 `AUTO-INC` 锁策略，使得 `AUTO-INC` 锁在分配完子增值并更新完自增计数器后立即释放，而不是在事务结束时释放。这种锁被称为 “轻量级AUTO-INC锁”，它大大提高了并发插入的性能，因为不同的事务可以更快地连续插入新记录到同一个表中。



[AUTO-INC 锁]: 08_AUTO-INC锁	"AUTO-INC 锁"

---

## 乐观锁

乐观锁（Optimistic Locking）是一种并发控制机制，适用于高并发和频繁读操作的场景。与悲观锁（Pessimistic Locking）不同，乐观锁在操作数据时假设不会发生并发冲突，因此在读取数据时不加锁，而是在更新数据时检查是否发生冲突。如果发生冲突，则采取相应的措施（如重试操作）。这种策略特别适用于读多写少的场景，因为它减少了锁的开销，提高了系统的吞吐量。



[乐观锁]: ./02-1_乐观锁	"乐观锁"

---

## 锁的分类

根据不同的维度，可以有以下的分类：

### 锁的粒度

- 全局锁
- 表级锁
- 行级锁
- 页级锁（Innodb 中不存在）

### 锁的级别

- 共享锁
- 排他锁

### 锁的对象

- 记录锁
- 间隙锁
- 临键锁

### 加锁方式

- 自动锁
- 显示锁

### 使用方式

- 乐观锁
- 悲观锁

另外还有 MDL 锁、DDL 锁、意向锁等。

---

## 对比总结

不同的锁机制适用于不同的场景，选择合适的锁机制可以提高数据库的并发性能和数据一致性。在实际应用中，应根据具体需求和操作类型来选择合适的锁策略。

| 锁类型     | 锁定粒度 | 加锁范围               | 并发性能 | 使用场景             |
| ---------- | -------- | ---------------------- | -------- | -------------------- |
| 表锁       | 表级别   | 整个表                 | 低       | DDL 操作、大批量更新 |
| 行锁       | 行级别   | 特定行（索引项）       | 高       | 高并发读写           |
| 意向锁     | 表级别   | 表明意向在某些行上加锁 | 中       | 行锁和表锁混合使用   |
| 间隙锁     | 行级别   | 索引记录之间的间隙     | 中       | 防止幻读             |
| 插入意向锁 | 行级别   | 索引记录之间的间隙     | 高       | 高并发插入           |