## 事务的基本知识

[toc]

#### 简介

在 MySQL 中，事务和隔离机制是确保数据库的完整性和一致性的重要概念。事务是一组数据库操作，它们要么全部成功（提交），要么全部失败（回滚）。为了保证多事务并发时数据库的一致性，MySQL 实现了多种隔离级别来控制事务间的相互影响。

---

#### 事务的基本属性 (ACID)

事务具备四个重要的性质，称为 **ACID**：

- **原子性 (Atomicity)**: 事务中的所有操作要么全部执行成功，要么全部回滚。没有部分成功的情况。
- **一致性 (Consistency)**: 事务的执行会使数据库从一种一致性状态转换到另一种一致性状态。即使发生故障，数据库的完整性约束也不会被破坏。
- **隔离性 (Isolation)**: 并发事务相互独立执行，互不干扰。隔离性决定了事务之间的可见性及相互影响程度。
- **持久性 (Durability)**: 一旦事务提交，其所做的修改将永久保留在数据库中，即使系统崩溃也能恢复。

---

#### 事务隔离级别

SQL 标准定义了四种事务隔离级别，MySQL 也支持这些级别。每个级别的隔离程度不同，解决并发问题的效果也不同。这四种隔离级别从低到高分别为：

##### 未提交读 (Read Uncommitted)

在未提交读级别下，一个事务可以读取另一个事务未提交的数据（**脏读**）。这是隔离级别最低的，几乎没有隔离性。

**特点**：

- 允许脏读 (Dirty Read)：一个事务能够读取到另一个未提交事务的修改。
- 允许不可重复读 (Non-repeatable Read)：同一个查询在同一事务中可能返回不同结果，因为其他事务可能提交修改。
- 允许幻读 (Phantom Read)：同一个查询条件在不同时间可能返回不同的结果行数。

##### 已提交读 (Read Committed)

在已提交读级别下，事务只能读取到其他事务已经提交的数据。这样可以避免脏读，但不能解决不可重复读和幻读问题。

**特点**：

- 禁止脏读：一个事务只能读取已提交的数据。
- 允许不可重复读：同一事务中执行相同的查询可能会得到不同的结果，因为其他事务可能在中途提交了修改。
- 允许幻读。

##### 可重复读 (Repeatable Read)

这是 MySQL 的默认隔离级别。可重复读保证在同一事务内，所有读操作的结果是稳定的，不会因为其他事务的修改而变化。MySQL 通过 **MVCC**（多版本并发控制）来实现可重复读，从而避免不可重复读的问题。

**特点**：

- 禁止脏读。
- 禁止不可重复读：同一个事务中执行相同查询，结果总是一致的，即使其他事务进行了修改。
- 允许幻读：即使同一个查询条件在不同时间返回相同的行，但仍可能有新行插入。

MySQL 通过 **Next-Key Locking**（锁住索引键和相邻的键）解决了幻读问题。

##### 串行化 (Serializable)

这是隔离级别最高的，也是开销最大的级别。所有事务都被强制串行执行，从而完全避免了脏读、不可重复读和幻读问题。它通过对每个查询加锁实现，但性能较低，适合非常高一致性要求的场景。

**特点**：

- 禁止脏读、不可重复读和幻读。
- 串行化运行：每个事务都像是在一个完全隔离的环境中独立运行。

##### 幻读和 MVCC

MySQL 的默认存储引擎 InnoDB 通过 **多版本并发控制 (MVCC)** 来避免幻读问题。MVCC 允许事务在读取时看到某个数据的快照，而不会被其他事务的操作所影响。它通过维护多个版本的行来实现并发控制，从而提高性能和数据一致性。

---

#### 常见并发问题

并发事务之间可能会产生以下几种问题，隔离级别不同，对这些问题的处理方式也不同：

- **脏读** (Dirty Read)：一个事务读取到另一个未提交事务的修改。比如：事务A读取了事务B未提交的数据，如果事务B回滚了，则事务A读取的数据是无效的。
- **不可重复读** (Non-repeatable Read)：同一事务中多次读取同一数据，结果不同，因为其他事务修改了数据。比如：事务A在两次读取同一数据时，发现事务B在两次读取之间修改了数据，导致A的两次读取结果不同。
- **幻读** (Phantom Read)：同一查询在不同时间返回的数据行数不同，因为其他事务插入或删除了符合条件的行。比如：事务A读取了满足某个条件的多行数据，事务B随后插入了一行满足该条件的新数据。事务A再次读取时，会发现多了一行“幻影”数据。

---

#### InnoDB 事务实现

MySQL 的 InnoDB 存储引擎通过以下机制来支持事务和隔离性：

- **Redo Log**：Redo Log 用于保证事务的持久性（D），记录所有已提交事务的修改。
- **Undo Log**：Undo Log 用于保证事务的原子性（A）和一致性（C），用于实现回滚操作和多版本并发控制（MVCC）。
- **锁机制**：InnoDB 使用行级锁来提高并发性，避免表级锁带来的性能问题。它支持 **共享锁 (S)** 和 **排他锁 (X)**，并使用 **意向锁** (Intention Locks) 来优化加锁过程。
- **MVCC (多版本并发控制)**：MVCC 通过为每个事务生成不同的快照来实现隔离，使得可重复读隔离级别下的读操作不需要加锁。
- **Next-Key Locking**：这是一种索引记录锁与间隙锁的结合，解决了幻读问题。

---

#### 事务的控制命令

- **START TRANSACTION** 或 **BEGIN**：显式启动一个事务。
- **COMMIT**：提交当前事务，将事务中的所有操作持久化到数据库中。
- **ROLLBACK**：回滚当前事务，撤销自事务开始以来的所有操作。
- **SAVEPOINT**：设置事务中的保存点，允许部分回滚。
- **ROLLBACK TO SAVEPOINT**: 回滚到指定的保存点，而不影响保存点之后的操作。
- **SET TRANSACTION ISOLATION LEVEL**：设置当前会话的事务隔离级别。

---

#### 总结

事务和隔离机制是 MySQL 数据库管理中的核心概念。根据不同的业务场景，可以选择合适的隔离级别来平衡性能和数据一致性。在高并发环境下，选择合理的隔离级别并结合 InnoDB 的事务特性，如 MVCC 和锁机制，能够显著提升系统的稳定性和响应速度。