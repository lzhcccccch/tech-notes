# MySQL 索引基础概念

[toc]

## 定义

索引是数据库表中一个或多个列的值存储在一个特定的数据结构中（通常是 B+树或者哈希表），这样的数据结构可以让信息检索更加快速。

---

## 特点：

- **实质**：索引的实质是一种特殊的文件（索引文件），索引由一系列索引项组成，每一种索引项由索引字段和行指针（指向数据表中的行数据）构成。
- **存储**：索引文件和数据表单独存放，索引可以存储在内存中也可以存储在磁盘上，这取决于索引的类型和数据库的配置。内存中的索引可以提供更快的访问速度，而磁盘上的索引能够处理更大的数据量。
- **实现**：索引是在存储引擎中实现的，而不是在服务器层中实现的。

---

## 优缺点

### 优点

- **加速数据检索**：通过索引，可以显著减少查找数据所需的时间，尤其是在大表上，索引能够极大地提高查询性能。

- **提高排序和分组速度**：在 `ORDER BY` 和 `GROUP BY` 操作中使用索引，可以减少数据排序和分组的时间。

- **强制唯一性**：唯一索引确保索引列的值是唯一的，防止数据重复。

- **提高联合查询效率**：多表联合查询时，索引能够加快表之间连接的速度。

- **加速范围查询**：索引可以提高范围查询的效率，如 `BETWEEN`、`>`, `<`、`>=`、`<=` 等。

- **特性**：减少服务器扫描的数据量，避免排序和临时表，让随机 IO 变成顺序 IO，适用于数据区别度大的列。

### 缺点

- **增加存储空间**：索引需要额外的存储空间来保存索引结构。数据量越大，空间成本越高。
- **降低写操作性能**：插入、更新、删除操作需要同时更新索引，增加了额外的开销，导致操作时间变长。
- **索引维护开销**：复杂的索引结构需要维护，特别是在数据频繁变动的表中。数据量越大，时间成本越高。
- **数量限制**： 同一个数据表里的索引总数限制为16个。

---

## 索引中的数据结构

> 详见：
>
> [MySQL 索引的数据结构]: ./02_数据结构	"MySQL 索引的数据结构"

MySQL 使用多种数据结构来实现索引，每种数据结构都有其特定的用途和优势。以下是MySQL中常见的索引数据结构，以及它们的详细介绍和对比：

### B Tree 结构

B-Tree 是一种平衡树结构，广泛用于数据库和操作系统中，用于存储和管理大块数据。

### B+ Tree 结构

B+ Tree 是一种平衡树结构，所有叶子节点都在同一层，叶子节点存储数据记录，并通过链表连接。B+ Tree 是 MySQL 的默认索引类型，特别是在 InnoDB 存储引擎中。

### B Tree 和 B+ Tree 对比

| 特性       | B+ Tree                                            | B Tree                                         |
| ---------- | -------------------------------------------------- | ---------------------------------------------- |
| 数据存储   | 内部节点存储索引键，叶子节点存储数据和指针         | 所有节点都存储数据                             |
| 叶子节点   | 通过双向链表连接，支持有序遍历                     | 叶子节点不一定通过链表连接，不便于范围查询     |
| 查询效率   | 查询性能稳定，适合范围查询和有序遍历               | 查询性能较为稳定，但不如 B+ Tree 高效          |
| 空间占用   | 节点存储大量指针和冗余数据，空间开销较大           | 节点存储数据较多，空间利用率相对较高           |
| 维护复杂性 | 插入、删除和更新操作复杂，需要维护树的平衡         | 插入、删除和更新操作同样复杂，需要维护树的平衡 |
| 适用场景   | 广泛用于数据库索引，特别是支持范围查询和排序的场景 | 一般用于需要存储大量数据的场景，范围查询较少   |

B+ Tree 是 MySQL 中最常用的索引数据结构，具有高效的范围查询和有序遍历能力，查询性能稳定。而 B Tree 虽然也有其优点，但由于其叶子节点不一定通过链表连接，不适合范围查询和排序操作。因此，在实际数据库应用中，B+ Tree 更为广泛使用。

### 哈希表结构

哈希索引基于哈希表实现，主要用于等值比较查询，即精确匹配搜索。它不保持数据的任何排序顺序，而是直接通过计算键的哈希值来定位数据行。

### 倒排索引结构

倒排索引用于全文搜索，特别适合处理大量文本数据。

### R-Tree 结构

R-Tree 是一种用于空间数据索引的树结构，特别适合地理信息系统（GIS）中的空间查询。

### 索引数据结构对比

| 数据结构 | 优点                                 | 缺点                               | 适用场景                                 |
| -------- | ------------------------------------ | ---------------------------------- | ---------------------------------------- |
| B+ Tree  | 支持范围查询和有序遍历，查询性能稳定 | 空间占用大，更新开销高             | 大多数查询场景，特别是排序和分组         |
| 哈希表   | 等值查询速度极快，结构简单           | 不支持范围查询和排序，冲突处理复杂 | 高效等值查询，内存存储引擎               |
| 倒排索引 | 全文搜索高效，查询灵活               | 空间占用大，更新复杂               | 需要全文搜索功能的应用，InnoDB 和 MyISAM |
| R-Tree   | 支持空间查询，自动调整平衡           | 实现复杂，范围查询性能较差         | 地理信息系统，MyISAM 存储引擎            |

---

## 索引的具体分类

> 详见
>
> [MySQL 中的索引]: ./03_索引分类	"MySQL 中的索引"

在 MySQL 中，索引是数据库表的一种数据结构，用于提高查询性能。不同类型的索引适用于不同的查询需求和存储引擎。

其中，普通索引、唯一索引、主键索引、复合索引、前缀索引可以统称为 B+ Tree 索引。

### 普通索引

普通索引是最基本的索引类型，用于加速数据的查询。它并不要求列的值唯一。

数据结构是 B+ Tree 结构。

### 唯一索引

唯一索引确保索引列中的所有值（单个列或多个列的组合索引）都是唯一的，但允许有一个 NULL 值。

数据结构是 B+ Tree 结构。

### 主键索引

主键索引是一种特殊的唯一索引，不允许有 NULL 值。每个表只能有一个主键。

在 InnoDB 中，主键索引就是聚簇索引，非主键索引就是非聚簇索引。

数据结构是 B+ Tree 结构。

### 复合索引

复合索引是在多个字段上创建索引，index(a,b,c)存储时先根据 a 排序，a 一样就根据 b 排序，b 一样根据 c 排序，所以要遵循**最左匹配原则**。

**最左前缀原则**：就是说只有在查询条件中使用了复合索引的第一个字段，索引才会生效。

复合索引可以是普通索引，也可以是唯一索引。

数据结构是 B+ Tree 结构。

### 哈希索引

哈希索引基于哈希表实现，只有Memory存储引擎默认支持哈希索引。哈希索引适用于等值比较查询。

数据结构是哈希结构。

### 全文索引

全文索引专门用于全文检索。MySQL中的InnoDB和MyISAM存储引擎支持全文索引。

数据结构是倒排索引结构。

### 空间索引

空间索引用于处理地理数据，只有MyISAM存储引擎支持真正的空间索引，使用R-Tree算法。

数据结构是 R-Tree 结构。

### 前缀索引

前缀索引不是一个单独的索引类型，而是一种可以在创建索引时指定的技术，通过只索引字段值的前几个字符来减少索引大小。例如，如果你有一个很长的文本列，但你知道前 10 个字符通常足够区分大多数行，你可以只索引前 10 个字符。

数据结构是 B+ Tree 结构。

---

## 引擎和索引类型

MySQL 支持多种存储引擎，每种引擎支持不同类型的索引。以下是常见的 MySQL 存储引擎及其支持的索引类型：

### InnoDB

InnoDB 是 MySQL 中最常用的存储引擎，支持以下索引类型：

- **B+ Tree 索引**：
  - **主键索引（Primary Key Index）**：使用 B+ Tree 实现的聚集索引。
  - **唯一索引（Unique Index）**：使用 B+ Tree 实现的唯一索引。
  - **普通索引（Index）**：使用 B+ Tree 实现的非唯一索引。
- **全文索引（Full-Text Index）**：
  - 支持全文搜索的倒排索引，从 MySQL 5.6 开始支持。
- **空间索引（Spatial Index）**：
  - 从 MySQL 5.7 开始，InnoDB 支持部分空间索引功能。
  - 支持几何数据类型（GEOMETRY, POINT, LINESTRING, POLYGON 等）

示例：

```sql
CREATE TABLE example_innodb (
    id INT PRIMARY KEY,                           -- 主键索引
    name VARCHAR(100),                            -- 普通索引
    description TEXT,
    content TEXT,
    location GEOMETRY,
    INDEX (name),                                 -- 普通索引
    UNIQUE (name),                                -- 唯一索引
    FULLTEXT (content),                           -- 全文索引
    SPATIAL INDEX (location)                      -- 空间索引
) ENGINE=InnoDB;
```

### MyISAM

MyISAM 是 MySQL 中的一个早期存储引擎，支持以下索引类型：

- **B+ Tree 索引**：
  - **主键索引（Primary Key Index）**：使用 B+ Tree 实现。
  - **唯一索引（Unique Index）**：使用 B+ Tree 实现。
  - **普通索引（Index）**：使用 B+ Tree 实现。
- **全文索引（Full-Text Index）**：
  - 支持全文搜索的倒排索引。
- **空间索引（Spatial Index）**：
  - 支持地理空间数据的 R-Tree 索引。

示例：

```sql
CREATE TABLE myisam_example (
    id INT PRIMARY KEY,                      -- 主键索引
    email VARCHAR(100) UNIQUE,               -- 唯一索引
    name VARCHAR(100),
    content TEXT,
    geom GEOMETRY,
    INDEX idx_name (name),                   -- 普通索引
    FULLTEXT (content),                      -- 全文索引
    SPATIAL INDEX (geom)                     -- 空间索引
) ENGINE=MyISAM;
```

### MEMORY（HEAP）

MEMORY 存储引擎将数据存储在内存中，适用于需要快速访问的小型表，支持以下索引类型：

- **哈希索引（Hash Index）**：
  - 默认使用哈希索引来加速等值查询。
- **B Tree 索引**：
  - 也支持 B Tree 索引，适用于范围查询。

示例：

```sql
CREATE TABLE memory_example (
    id INT PRIMARY KEY,                      -- 主键索引
    name VARCHAR(100),
    age INT,
    INDEX idx_name (name) USING HASH,        -- 哈希索引
    INDEX idx_age (age) USING BTREE          -- B Tree 索引
) ENGINE=MEMORY;
```

### NDB Cluster

NDB Cluster 存储引擎用于 MySQL 集群，支持以下索引类型：

- **B Tree 索引**：
  - **主键索引（Primary Key Index）**。
  - **唯一索引（Unique Index）**。
  - **普通索引（Index）**。
- **哈希索引（Hash Index）**：
  - 默认情况下，使用哈希索引来分布数据。

示例：

```sql
CREATE TABLE example_ndb (
    id INT PRIMARY KEY,                       -- 主键索引
    name VARCHAR(100),
    age INT,
    INDEX idx_name (name) USING HASH,         -- 哈希索引
    INDEX idx_age (age) USING BTREE           -- B-Tree 索引
) ENGINE=NDBCLUSTER;
```

### Archive

Archive 存储引擎适用于存储和压缩大量历史归档数据，支持以下索引类型：

- 没有索引支持：
  - Archive 存储引擎只支持自动生成的主键索引，不能创建额外的索引。

示例：

```sql
CREATE TABLE archive_example (
    id INT AUTO_INCREMENT PRIMARY KEY,       -- 自动生成的主键索引
    name VARCHAR(100),
    age INT
) ENGINE=ARCHIVE;
```

### CSV

CSV 存储引擎将数据存储在 CSV 文件中，支持以下索引类型：

- 没有索引支持：
  - CSV 存储引擎不支持创建任何索引。

示例：

```sql
CREATE TABLE csv_example (
    id INT PRIMARY KEY,                      -- 主键索引
    name VARCHAR(100),
    age INT
) ENGINE=CSV;
```

### FEDERATED

FEDERATED 存储引擎支持远程表的索引，但本地不存储索引

### 小结

| 存储引擎      | 支持的索引类型                                       |
| ------------- | ---------------------------------------------------- |
| **InnoDB**    | B+ Tree 索引（普通、唯一、主键）、全文索引、空间索引 |
| **MyISAM**    | B+ Tree 索引（普通、唯一、主键）、全文索引、空间索引 |
| **MEMORY**    | 哈希索引、B Tree 索引                                |
| **NDB**       | B Tree 索引（普通、唯一、主键）、哈希索引            |
| **Archive**   | 没有额外索引支持，只支持自动主键索引                 |
| **CSV**       | 没有额外索引支持                                     |
| **FEDERATED** | 支持远程表的索引，但本地不存储索引                   |

每种存储引擎的索引支持情况不同，在设计数据库时，应根据实际需求选择合适的存储引擎和索引类型。InnoDB 是 MySQL 默认的存储引擎，支持最全面的索引类型，适用于大多数应用场景。MyISAM 支持类似的索引类型，但缺乏事务支持。MEMORY 存储引擎主要用于需要快速访问的临时数据，支持哈希索引和 B-Tree 索引。NDB 适用于分布式环境，支持 B-Tree 和哈希索引。ARCHIVE 适用于存储大量历史数据，只支持简单的 B-Tree 索引。CSV 和 FEDERATED 存储引擎有各自特定的应用场景，但对索引的支持有限。

---

## 总结

本文主要介绍了 MySQL 索引的基本概念，包括索引的数据结构、索引的分类、索引的优缺点以及不同的 MySQL 引擎支持的索引类型。索引最主要的目的是快速查询，在实际使用中，要根据不同的场景，为数据表选择合适的引擎和索引。
