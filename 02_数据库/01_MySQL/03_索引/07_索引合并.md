## 索引合并

[toc]

#### 简介

索引合并（Index Merge）是 MySQL 的一种优化策略，允许在单个查询中使用多个单列索引或部分复合索引，从而提高查询性能。通常，MySQL 优化器在查询中选择一个最优的单一索引来执行查询，而索引合并则允许在需要的情况下同时利用多个索引来完成查询任务，并将这些索引的结果合并起来，从而避免了完全依赖单个复合索引或者执行全表扫描的情况。

---

#### 工作原理

索引合并策略允许 MySQL 使用多个索引的组合来查找数据，而不是只依赖于一个单一索引。这种技术对于那些没有覆盖索引或无法使用单个索引高效执行的查询特别有用。通过合并多个索引的结果集，MySQL 可以有效地优化查询性能。

**示例**

假设有如下表 `employee`：

~~~sql
CREATE TABLE employee (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    age INT,
    department_id INT,
    salary DECIMAL(10, 2),
    INDEX idx_name (name),
    INDEX idx_age (age)
);
~~~

我们有如下查询：

~~~sql
SELECT * FROM employee WHERE name = 'John' OR age = 30;
~~~

对于该查询，MySQL 可以选择**索引合并**策略：

- 分别使用 `idx_name` 和 `idx_age` 索引扫描 `name = 'John'` 和 `age = 30` 的记录
- 将这两个索引扫描的结果集进行合并（UNION 操作）。
- 获取最终结果集并返回。

---

#### 索引合并的类型

索引合并的核心思想是利用多个单列索引来处理查询条件，并将每个索引的结果集进行合并，以满足查询的需求。索引合并的主要类型包括以下几种：

##### Intersection（交集）

- 当查询条件是 `AND` 操作符连接的多个条件时，MySQL 可以通过多个索引分别查找结果集，然后使用 `INTERSECTION `操作合并这些结果集。

- 例如，查询条件为 `name = 'John' AND age = 30`时，可以分别使用 `idx_name` 和 `idx_age` 扫描并取结果集的交集，然后根据交集的 `id` 进行回表查询。

- 不过要想使用取交集的联合索引，需要满足各自索引查出来的主键id是排好序的，这是为了方便可以快速的取交集。比如下面这条sql就无法使用联合索引：

  ~~~sql
  select * from `user` where name = '赵六' and age > 22;
  ~~~

  只能用 `name` 这个索引，因为`age > 22` 查出来的 `id` 是无序的。由此可以看出，使用联合索引条件还是比较苛刻的。

##### Union（并集）

- 当查询条件是 `OR` 操作符连接的多个条件时，MySQL 可以通过多个索引分别查找结果集，然后使用 `UNION` 操作合并这些结果集。
- 例如，查询条件为 `name = 'John' OR age = 30` 时，分别使用 `idx_name` 和 `idx_age` 扫描并合并结果集，然后根据并集的 `id` 进行回表查询。
- 同样地，取并集也要求各自索引查出来的主键 `id` 是排好序的。

##### Sort-Union（排序后取并集）

- 当 MySQL 无法在内存中高效地合并多个索引的结果集时，可能会将结果集写入临时表，并对临时表进行排序以合并结果。
- 通常用于大型数据集的查询。
- 虽然取并集要求各自索引查出来的主键 `id` 是排好序的，但是如果遇到没排好序的情况，mysql 会自动对这种情况进行优化，会先对主键 `id` 排序，然后再取并集，这种情况就叫排序后取并集（sort-union）。

---

#### 使用索引合并的条件

MySQL 优化器会自动决定是否使用索引合并策略，但这种选择取决于查询的具体情况。索引合并策略通常在以下情况下被使用：

1. **多个单列索引**：表上存在多个单列索引，且查询条件中涉及这些索引列。
2. **复合索引的部分列匹配**：查询中使用了复合索引的部分列，但不能完全利用复合索引的优势。
3. **没有更好的单索引可用**：当单个索引不能显著优化查询时，MySQL 会尝试索引合并。

---

#### 索引合并的使用情况和限制

##### 使用情况

- 对于 `OR` 和 `AND` 组合的查询非常有用。
- 对于一些复杂的查询条件，能够显著减少表扫描次数，提高查询性能。
- 索引合并优化策略是在优化器阶段**自动启用**的，用户不需要显式配置。

##### 限制

- 索引合并在某些情况下可能不如单个覆盖索引高效，尤其是在大数据量查询时。MySQL 优化器会根据成本选择是否使用索引合并。
- 并非所有存储引擎都支持索引合并，通常 InnoDB 支持较好（MyISAM也支持）。
- 如果表上有更优的单列索引或者复合索引，MySQL 优化器通常不会选择索引合并。

##### 如何查看是否使用了索引合并

可以使用 `EXPLAIN` 命令查看查询是否使用了索引合并策略。通过查看 `type` 、 `possible_keys` 和 ` key` 字段，确定 MySQL 使用了哪些索引。`type` 字段中显示的 `index_merge` 表示使用了索引合并策略，`Extra` 中会提示具体用了哪种索引合并策略（`Using intersect`、`Using union`、`Using sort-unoin`）。

示例：

~~~sql
EXPLAIN SELECT * FROM employee WHERE name = 'John' AND age = 30;
~~~

如果输出的 `Extra` 列中有 `Using intersect(idx_age,idx_name)` 字样，表示该查询使用了索引合并策略。

---

#### 优缺点

**优点：**

- **提高查询效率**：索引合并能够利用多个索引组合，提高查询执行效率，避免全表扫描。
- **灵活性**：索引合并允许在没有复合索引的情况下处理多条件查询，提供了更大的灵活性。

**缺点：**

- **开销较大**：索引合并需要对多个索引的结果进行合并，可能会引入额外的计算开销。
- **未必最优**：对于复杂查询，特别是当条件较多且涉及多个字段时，索引合并并不一定比复合索引更优，有时使用复合索引会有更好的性能。

---

#### 总结

MySQL 的索引合并为处理多条件查询提供了灵活的解决方案，特别是在没有合适的复合索引时，可以显著提高查询效率。然而，索引合并并不总是最优的选择，因此在实际应用中，了解查询模式和索引设计的关系，灵活选择合适的优化策略，仍然是保证数据库性能的关键。