# SQL 语句执行顺序

[toc]

## 简介

在 MySQL 中，SQL 语句的执行顺序与我们书写 SQL 的顺序并不完全一致。SQL 的执行是按照逻辑查询处理的顺序进行的。以下是 SQL 语句的执行顺序详细说明以及流程图。

---

## SQL 执行的逻辑顺序

### 1. FROM 子句

- 确定查询的数据来源（表或视图），以及表之间的连接方式（`JOIN`）。
- 如果有多表连接，首先会生成笛卡尔积，然后根据 `ON` 条件过滤数据。
- 如果有子查询，优先执行子查询。

### 2. WHERE 子句

- 对 `FROM` 子句返回的数据进行行级过滤。
- 只保留满足条件的记录。

### 3. GROUP BY 子句

- 对 `WHERE` 子句过滤后的数据进行分组。
- 数据被分成多个组，每组会进行后续的聚合计算。

### 4. HAVING 子句

- 对分组后的数据进行过滤。
- 类似于 `WHERE`，但 `HAVING` 是针对分组后的数据进行过滤。

### 5. SELECT 子句

- 确定需要返回的列，执行列的计算或别名的指定。
- 如果哟聚合函数（如 `SUM`、`AVG`等），在此阶段进行计算。

### 6. DISTINCT 子句

- 对 `SELECT` 返回的数据进行去重。

### 7. ORDER BY 子句

- 对 `SELECT` 返回的数据进行排序。

### 8. LIMIT 子句

- 限制返回的记录数。

---

## SQL 执行顺序图

~~~mermaid
graph TD
  A(FROM 子句: 数据来源) --> B(WHERE 子句: 行级过滤)
  B --> C(GROUP BY 子句: 分组)
  C --> D(HAVING 子句: 分组过滤)
  D --> E(SELECT 子句: 返回列、计算)
  E --> F(DISTINCT 子句: 去重)
  F --> G(ORDER BY 子句: 排序)
  G --> H(LIMIT 子句: 限制返回条数)
~~~

**说明**

- `FROM` 子句是第一步，它决定了查询的数据来源以及如何将多表联合起来。
- `WHERE` 和 `HAVING` 的区别：
  -  `WHERE` 是在数据进行分组之前进行过滤。
  - `HAVING` 实在数据分组之后对分组结果进行过滤。
- `SELECT` 的位置靠后，尽管我们在写 SQL 时，`SELECT` 通常是第一个写，但它实际上是逻辑上靠后的步骤。
- `DISTINCT` 去重在 `ORDER BY`  排序之前完成。

---

## 总结

MySQL 的 SQL 语句的执行顺序语书写顺序不同，理解其逻辑执行顺序对于编写高效 SQL 至关重要。在优化 SQL 时，通常将最耗时的操作提前完成，比如 `WHERE` 过滤。知道 SQL 语句的执行顺序，可以减少不必要的中间结果，比如在 `GROUP BY` 之前过滤更多数据，减少分组的数量。